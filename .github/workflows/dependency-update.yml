name: Dependency Updates and Security Patches

on:
  schedule:
    # Run every Monday at 8 AM UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    name: Update Dependencies
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install pip-tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools
      
      - name: Update requirements
        run: |
          # Compile updated requirements
          pip-compile --upgrade --resolver=backtracking requirements.in -o requirements.txt
          
          # Check for security updates
          pip install pip-audit
          pip-audit -r requirements.txt --fix --dry-run > security_updates.txt
      
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet requirements.txt; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: Update dependencies'
          title: 'ðŸ”„ Automated Dependency Updates'
          body: |
            ## Automated Dependency Updates
            
            This PR contains automated dependency updates generated by the weekly scan.
            
            ### Changes
            - Updated Python dependencies in `requirements.txt`
            - Applied security patches where available
            
            ### Security Scan Results
            ```
            $(cat security_updates.txt || echo "No security issues found")
            ```
            
            ### Review Checklist
            - [ ] Review dependency changes
            - [ ] Check for breaking changes in major version updates
            - [ ] Verify tests pass with new dependencies
            - [ ] Review security advisories for updated packages
            
            ---
            *This PR was automatically generated by GitHub Actions*
          branch: automated-dependency-updates
          delete-branch: true
          labels: |
            dependencies
            security
            automated

  dependabot-auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    name: Auto-merge Dependabot PRs
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
      
      - name: Auto-merge minor and patch updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}