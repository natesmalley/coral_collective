name: Release and Version Management

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(python -c "from coral_collective import __version__; print(__version__)")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
      
      - name: Calculate new version
        id: bump
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          TYPE="${{ github.event.inputs.version_type }}"
          
          # Parse current version
          IFS='.' read -r major minor patch <<< "$CURRENT"
          
          # Bump version based on type
          case $TYPE in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac
          
          NEW_VERSION="$major.$minor.$patch"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
      
      - name: Update version in files
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"
          
          # Update __init__.py
          sed -i "s/__version__ = .*/__version__ = \"$NEW_VERSION\"/" coral_collective/__init__.py
          
          # Update setup.py if it has hardcoded version
          if grep -q "version=" setup.py; then
            sed -i "s/version=\".*\"/version=\"$NEW_VERSION\"/" setup.py
          fi
      
      - name: Generate changelog
        id: changelog
        run: |
          echo "## What's Changed" > changelog.md
          echo "" >> changelog.md
          
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            git log --pretty=format:"- %s (%an)" >> changelog.md
          else
            git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%an)" >> changelog.md
          fi
          
          echo "" >> changelog.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${LAST_TAG}...v${{ steps.bump.outputs.new_version }}" >> changelog.md
          
          # Output for later use
          CHANGELOG=$(cat changelog.md)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Commit version bump
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "chore: Bump version to ${{ steps.bump.outputs.new_version }}"
          git tag -a "v${{ steps.bump.outputs.new_version }}" -m "Release v${{ steps.bump.outputs.new_version }}"
          git push origin main --tags

  build-and-release:
    runs-on: ubuntu-latest
    needs: [version-bump]
    if: always() && (needs.version-bump.result == 'success' || startsWith(github.ref, 'refs/tags/'))
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel setuptools
      
      - name: Get version
        id: version
        run: |
          if [ "${{ needs.version-bump.outputs.new_version }}" != "" ]; then
            VERSION="${{ needs.version-bump.outputs.new_version }}"
          else
            VERSION=${GITHUB_REF_NAME#v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Build Python package
        run: |
          python -m build
          ls -la dist/
      
      - name: Create release archives
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Create zip archive
          zip -r "coral-collective-v${VERSION}.zip" \
            coral_collective/ \
            agents/ \
            config/ \
            mcp/ \
            tools/ \
            templates/ \
            docs/ \
            examples/ \
            *.py \
            *.sh \
            *.md \
            requirements.txt \
            pyproject.toml \
            Dockerfile \
            docker-compose.yml \
            LICENSE \
            -x "*.pyc" \
            -x "*__pycache__*" \
            -x "*.git*"
          
          # Create tar.gz archive
          tar -czf "coral-collective-v${VERSION}.tar.gz" \
            --exclude="*.pyc" \
            --exclude="*__pycache__*" \
            --exclude=".git*" \
            coral_collective/ \
            agents/ \
            config/ \
            mcp/ \
            tools/ \
            templates/ \
            docs/ \
            examples/ \
            *.py \
            *.sh \
            *.md \
            requirements.txt \
            pyproject.toml \
            Dockerfile \
            docker-compose.yml \
            LICENSE
          
          # Create minimal deployment package
          mkdir -p coral-collective-minimal
          cp -r coral_collective agents config coral-collective-minimal/
          cp setup.py requirements.txt README.md LICENSE coral-collective-minimal/
          zip -r "coral-collective-minimal-v${VERSION}.zip" coral-collective-minimal/
          
          ls -lah *.zip *.tar.gz
      
      - name: Generate release notes
        id: notes
        run: |
          if [ "${{ needs.version-bump.outputs.changelog }}" != "" ]; then
            echo "${{ needs.version-bump.outputs.changelog }}" > release_notes.md
          else
            echo "## Release v${{ steps.version.outputs.version }}" > release_notes.md
            echo "" >> release_notes.md
            echo "### Installation" >> release_notes.md
            echo '```bash' >> release_notes.md
            echo "pip install coral-collective==${{ steps.version.outputs.version }}" >> release_notes.md
            echo '```' >> release_notes.md
            echo "" >> release_notes.md
            echo "### Downloads" >> release_notes.md
            echo "- ðŸ“¦ Full Package: coral-collective-v${{ steps.version.outputs.version }}.zip" >> release_notes.md
            echo "- ðŸ—œï¸ Compressed: coral-collective-v${{ steps.version.outputs.version }}.tar.gz" >> release_notes.md
            echo "- ðŸŽ¯ Minimal: coral-collective-minimal-v${{ steps.version.outputs.version }}.zip" >> release_notes.md
          fi
          
          NOTES=$(cat release_notes.md)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: CoralCollective v${{ steps.version.outputs.version }}
          body: ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            coral-collective-v${{ steps.version.outputs.version }}.zip
            coral-collective-v${{ steps.version.outputs.version }}.tar.gz
            coral-collective-minimal-v${{ steps.version.outputs.version }}.zip
            dist/*.whl
            dist/*.tar.gz
      
      - name: Upload to PyPI
        if: github.event.inputs.prerelease != 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          pip install twine
          twine upload dist/* --skip-existing
        continue-on-error: true

  docker-release:
    runs-on: ubuntu-latest
    needs: [build-and-release]
    if: success()
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version
        id: version
        run: |
          if [ "${{ needs.version-bump.outputs.new_version }}" != "" ]; then
            VERSION="${{ needs.version-bump.outputs.new_version }}"
          else
            VERSION=${GITHUB_REF_NAME#v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        continue-on-error: true
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  update-documentation:
    runs-on: ubuntu-latest
    needs: [build-and-release]
    if: success() && github.event.inputs.prerelease != 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Update installation docs
        run: |
          VERSION="${{ needs.version-bump.outputs.new_version }}"
          if [ -z "$VERSION" ]; then
            VERSION=${GITHUB_REF_NAME#v}
          fi
          
          # Update README with latest version
          sed -i "s/coral-collective-v[0-9]*\.[0-9]*\.[0-9]*/coral-collective-v$VERSION/g" README.md
          sed -i "s/version [0-9]*\.[0-9]*\.[0-9]*/version $VERSION/g" docs/DEPLOYMENT.md
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A
          git diff --quiet && git diff --staged --quiet || git commit -m "docs: Update documentation for v$VERSION"
          git push origin main
        continue-on-error: true